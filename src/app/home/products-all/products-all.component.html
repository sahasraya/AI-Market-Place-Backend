<div class="products-container">
  <!-- Header Section -->
  <div class="header-section">
    <h1 class="mainheading">
      <span class="material-icons">inventory_2</span>
      All Products
    </h1>
    <button class="createnewbtn" (click)="addProduct()">
      <span class="material-icons">add</span>
      Add Product
    </button>
  </div>

  <!-- Search Section -->
  <div class="search-section">
    <div class="search-wrapper">
      <span class="material-icons search-icon">search</span>
      <input
        type="text"
        placeholder="Search by product name, category, technology..."
        [(ngModel)]="searchText"
        (input)="onSearch()"
        class="search-input"
      />
      <span 
        *ngIf="searchText" 
        class="material-icons clear-icon" 
        (click)="clearSearch()">
        clear
      </span>
    </div>
  </div>

  <!-- Products Table -->
  <div class="table-container">
    <table class="products-table">
      <thead>
        <tr>
          <th>Image</th>
          <th>Product Name</th>
          <th>Category</th>
          <th>License</th>
          <th>Technology</th>
          <th>Funding Stage</th>
          <th>Reviews</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let product of filteredProducts" class="table-row">
          <td>
            <img 
              [src]="product.productImage" 
              [alt]="product.productName" 
              class="product-img"
              (error)="onImageError($event)" />
          </td>
          <td class="product-name clickable" (click)="openProduct(product)">
            <span class="material-icons product-icon">inventory_2</span>
            {{ product.productName }}
          </td>
          <td>
            <span class="badge category-badge">{{ product.productCategory }}</span>
          </td>
          <td>{{ product.license }}</td>
          <td>
            <div class="tech-tags">
              <span *ngFor="let tech of product.technology.slice(0, 2)" class="tech-tag">
                {{ tech }}
              </span>
              <span *ngIf="product.technology.length > 2" class="tech-more">
                +{{ product.technology.length - 2 }}
              </span>
            </div>
          </td>
          <td>
            <span class="badge funding-badge">{{ product.fundingStage }}</span>
          </td>
          <td>
            <button class="btn-icon reviews-btn" (click)="seeAllReviews(product)" title="See Reviews">
              <span class="material-icons">rate_review</span>
              <span class="review-count">{{ getReviewCount(product.id) }}</span>
            </button>
          </td>
          <td>
            <div class="action-buttons">
              <button class="action-btn edit" (click)="updateProduct(product)" title="Edit">
                <span class="material-icons">edit</span>
              </button>
              <button class="action-btn delete" (click)="deleteProduct(product)" title="Delete">
                <span class="material-icons">delete</span>
              </button>
              <button class="action-btn deactivate" (click)="deactivateProduct(product)" title="Deactivate">
                <span class="material-icons">block</span>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <div *ngIf="filteredProducts.length === 0" class="no-data">
      <span class="material-icons">inventory_2</span>
      <p>No products found</p>
    </div>
  </div>

  <!-- Product Popup -->
  <app-product
    *ngIf="selectedProduct"
    [product]="selectedProduct"
    [visible]="showProductPopup"
    (close)="closeProductPopup()">
  </app-product>

  <!-- Reviews Drawer -->
  <div class="drawer-overlay" *ngIf="showReviewsDrawer" (click)="closeReviewsDrawer()"></div>
  <div class="drawer reviews-drawer" [class.open]="showReviewsDrawer">
    <div class="drawer-header">
      <h2 class="drawer-title">
        <span class="material-icons">rate_review</span>
        Product Reviews
      </h2>
      <button class="close-drawer-btn" (click)="closeReviewsDrawer()">
        <span class="material-icons">close</span>
      </button>
    </div>

    <div class="drawer-body" *ngIf="selectedProductForReviews">
      <div class="drawer-info">
        <img [src]="selectedProductForReviews.productImage" [alt]="selectedProductForReviews.productName" class="drawer-product-img">
        <div class="drawer-product-info">
          <h3>{{ selectedProductForReviews.productName }}</h3>
          <p>{{ selectedProductForReviews.productCategory }}</p>
          <span class="review-total">{{ productReviews.length }} Reviews</span>
        </div>
      </div>

      <div class="reviews-list">
        <div 
          *ngFor="let review of displayedReviews" 
          class="review-card"
          (click)="openReviewPopup(review)">
          <div class="review-header">
            <div class="review-user">
              <span class="material-icons user-icon">account_circle</span>
              <div>
                <strong>{{ getUserName(review.userId) }}</strong>
                <p class="review-date">{{ review.createdDate | date: 'MMM dd, yyyy' }}</p>
              </div>
            </div>
            <div class="review-rating">
              <div class="stars">
                <span *ngFor="let star of getStars(review.overallExperience)" class="material-icons star">
                  {{ star }}
                </span>
              </div>
              <span class="rating-text">{{ review.overallExperience }}/5</span>
            </div>
          </div>

          <div class="review-details">
            <div class="review-info-item">
              <span class="material-icons">work</span>
              <span>{{ review.usageType }}</span>
            </div>
            <div class="review-info-item">
              <span class="material-icons">schedule</span>
              <span>{{ review.usageDuration }}</span>
            </div>
            <div class="review-info-item" *ngIf="review.usingPaidVersion">
              <span class="material-icons">paid</span>
              <span>Paid Version</span>
            </div>
          </div>

          <p class="review-comment">{{ review.otherComments | slice:0:120 }}{{ review.otherComments.length > 120 ? '...' : '' }}</p>
        </div>

        <div *ngIf="productReviews.length === 0" class="no-reviews">
          <span class="material-icons">rate_review</span>
          <p>No reviews yet for this product</p>
        </div>

        <button 
          *ngIf="hasMoreReviews" 
          class="load-more-btn"
          (click)="loadMoreReviews()">
          <span class="material-icons">expand_more</span>
          Load More Reviews
        </button>
      </div>
    </div>
  </div>

  <!-- Review Popup -->
  <app-review
    *ngIf="selectedReview"
    [review]="selectedReview"
    [visible]="showReviewPopup"
    (close)="closeReviewPopup()">
  </app-review>
</div>