<div class="products-container">
  <!-- Header Section -->
  <div class="header-section">
    <h1 class="mainheading">
      All Products
    </h1>
    <button class="createnewbtn" (click)="addProduct()">
      <span class="material-icons">add</span>
      Add Product
    </button>
  </div>

  <!-- Search Section -->
  <div class="search-section">
    <div class="search-wrapper">
      <span class="material-icons search-icon">search</span>
      <input type="text" placeholder="Search by product name, category, technology..." [(ngModel)]="searchText"
        (input)="onSearch()" class="search-input" />
      <span *ngIf="searchText" class="material-icons clear-icon" (click)="clearSearch()">
        clear
      </span>
    </div>
  </div>

  <!-- Products Table -->
  <div class="table-container">
    <table class="products-table">
      <thead>
        <tr>
          <th>Image</th>
          <th>Product Name</th>
          <th>Category</th>
          <th>License</th>
          <th>Funding Stage</th>
          <th>Reviews</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let product of filteredProducts" class="table-row" [class.inactive-row]="product.status === 0">
          <td>
            <div class="product-img-wrapper">
              <img [src]="getProductImage(product)" [alt]="product.productname" class="product-img"
                (error)="onImageError($event)" />
              <span class="featured-badge" *ngIf="product.isFeatured === 1">
                <span class="material-icons">star</span>
                Featured
              </span>
            </div>
          </td>
          <td class="product-name clickable" >
            {{ product.productname }}
          </td>
          <td>
            <span class="badge category-badge">{{ product.productcategory || '-' }}</span>
          </td>
          <td>{{ product.productlicense || '-' }}</td>

          <td>
            <span class="badge funding-badge">{{ product.productfundingstage || '-' }}</span>
          </td>
          <td>
            <button class="btn-icon reviews-btn" (click)="seeAllReviews(product)" title="See Reviews">
              <span class="material-icons">rate_review</span>
              <span class="review-count">{{ getReviewCount(product.productid) }}</span>
            </button>
          </td>
          <td>
            <div class="action-buttons">
              <!-- 1. Edit Button (Purple) -->

                  <button class="action-btn preview"  (click)="openProduct(product)" title="Preview Product">
                  <span class="material-icons">visibility</span>
                </button>

              <button class="action-btn edit" (click)="editProduct(product)" title="Edit Product">
                <span class="material-icons">edit</span>
              </button>

              <!-- 2. Assign Button (Blue) -->
              <button class="action-btn assign" (click)="openAssignPopup(product)" title="Assign to User">
                <span class="material-icons">person_add</span>
              </button>

              <!-- 3. Status Toggle Button (Green/Orange) -->
              <button class="action-btn" [class.deactivate]="product.status === 0"
                [class.activate]="product.status === 1" (click)="toggleProductStatus(product)"
                [title]="product.status === 0 ? 'Activate Product' : 'Deactivate Product'">
                <span class="material-icons">
                  {{ product.status === 0 ? 'check_circle' : 'block' }}
                </span>
              </button>

              <!-- 4. Delete Button (Red) -->
              <button class="action-btn delete" (click)="deleteProduct(product)" title="Delete">
                <span class="material-icons">delete</span>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <div *ngIf="filteredProducts.length === 0" class="no-data">
      <span class="material-icons">inventory_2</span>
      <p>No products found</p>
    </div>


  </div>

  <button class="load-more-btn" (click)="loadMoreProducts()" *ngIf="products.length < totalProducts">
    <span class="material-icons">expand_more</span>
    {{ loadMoreButtonText }}
  </button>









  <!-- Product Popup -->
  <app-product *ngIf="selectedProduct" [product]="selectedProduct" [visible]="showProductPopup"
    (close)="closeProductPopup()">
  </app-product>

  <!-- Reviews Drawer -->
  <div class="drawer-overlay" *ngIf="showReviewsDrawer" (click)="closeReviewsDrawer()"></div>
  <div class="drawer reviews-drawer" [class.open]="showReviewsDrawer">
    <div class="drawer-header">
      <h2 class="drawer-title">
        <span class="material-icons">rate_review</span>
        Product Reviews
      </h2>
      <button class="close-drawer-btn" (click)="closeReviewsDrawer()">
        <span class="material-icons">close</span>
      </button>
    </div>

    <div class="drawer-body" *ngIf="selectedProductForReviews">
      <!-- Product Info -->
      <div class="drawer-info">
        <img [src]="getProductImage(selectedProductForReviews)" [alt]="selectedProductForReviews.productname"
          class="drawer-product-img" (error)="onImageError($event)">
        <div class="drawer-product-info">
          <h3>{{ selectedProductForReviews.productname }}</h3>
          <p>{{ selectedProductForReviews.productcategory }}</p>
          <span class="review-total">{{ getReviewCount(selectedProductForReviews.productid) }} Reviews</span>
        </div>
      </div>

      <!-- Loading State -->
      <div *ngIf="isLoadingReviews" class="loading-state">
        <span class="spinner"></span>
        <p>Loading reviews...</p>
      </div>

      <!-- Reviews List -->
      <div class="reviews-list" *ngIf="!isLoadingReviews">
        <div *ngFor="let review of displayedReviews" class="review-card" (click)="openReviewPopup(review)">
          <div class="review-header">
            <div class="review-user">
              <span class="material-icons user-icon">account_circle</span>
              <div>
                <strong>{{ getUserName(review) }}</strong>
                <p class="review-date">{{ review.createddate | date: 'MMM dd, yyyy' }}</p>
              </div>
            </div>
            <div class="review-rating">
              <div class="stars">
                <span *ngFor="let star of getStars(review.experiencerate)" class="material-icons star">
                  {{ star }}
                </span>
              </div>
              <span class="rating-text">{{ review.experiencerate }}/5</span>
            </div>
          </div>

          <div class="review-details">
            <div class="review-info-item" *ngIf="review.commercialorpersonal">
              <span class="material-icons">work</span>
              <span>{{ review.commercialorpersonal }}</span>
            </div>
            <div class="review-info-item" *ngIf="review.howlong">
              <span class="material-icons">schedule</span>
              <span>{{ review.howlong }}</span>
            </div>
            <div class="review-info-item" *ngIf="review.paidornot === '1'">
              <span class="material-icons">paid</span>
              <span>Paid Version</span>
            </div>
          </div>

          <p class="review-comment" *ngIf="review.comment">
            {{ review.comment | slice:0:120 }}{{ review.comment.length > 120 ? '...' : '' }}
          </p>
        </div>

        <div *ngIf="productReviews.length === 0" class="no-reviews">
          <span class="material-icons">rate_review</span>
          <p>No reviews yet for this product</p>
        </div>

        <button *ngIf="hasMoreReviews && !isLoadingReviews" class="load-more-btn" (click)="loadMoreReviews()">
          <span class="material-icons">expand_more</span>
          Load More
        </button>
      </div>
    </div>
  </div>

  <!-- Review Popup -->
  <app-review *ngIf="selectedReview" [review]="selectedReview" [visible]="showReviewPopup" (close)="closeReviewPopup()">
  </app-review>
</div>












<div class="popup-overlay" *ngIf="showAssignPopup" (click)="closeAssignPopup()"></div>
<div class="popup assign-popup" [class.open]="showAssignPopup">
  <div class="popup-header">
    <h2 class="popup-title">
      <span class="material-icons">person_add</span>
      Assign Product to User
    </h2>
    <button class="close-popup-btn" (click)="closeAssignPopup()">
      <span class="material-icons">close</span>
    </button>
  </div>

  <div class="popup-body">
    <!-- Product Info -->
    <div class="assign-product-info" *ngIf="selectedProductForAssign">
      <img [src]="getProductImage(selectedProductForAssign)" [alt]="selectedProductForAssign.productname"
        class="assign-product-img" (error)="onImageError($event)">
      <div>
        <h3>{{ selectedProductForAssign.productname }}</h3>
        <p class="text-muted">{{ selectedProductForAssign.productcategory }}</p>
      </div>
    </div>

    <!-- Search User by Email -->
    <div class="search-user-section">
      <label class="search-label">Search User by Email</label>
      <div class="search-wrapper">
        <span class="material-icons search-icon">search</span>
        <input type="email" placeholder="Enter user email..." [(ngModel)]="userSearchEmail"
          (input)="onUserEmailSearch()" class="search-input" />
        <span *ngIf="userSearchEmail" class="material-icons clear-icon" (click)="clearUserSearch()">
          clear
        </span>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="isLoadingUsers" class="loading-state">
      <span class="spinner"></span>
      <p>Loading users...</p>
    </div>

    <!-- Users List -->
    <div class="users-list" *ngIf="!isLoadingUsers">
      <div *ngFor="let user of filteredUsersForAssign" class="user-card">
        <div class="user-info">
          <span class="material-icons user-avatar">account_circle</span>
          <div class="user-details">
            <strong>{{ user.name }}</strong>
            <p class="user-email">{{ user.email }}</p>
            <p class="user-designation" *ngIf="user.designation">{{ user.designation }}</p>
            <span class="badge" [class.active-badge]="user.status === 'active'"
              [class.disabled-badge]="user.status === 'disabled'">
              {{ user.status }}
            </span>
          </div>
        </div>
        <button class="btn-assign" (click)="assignProductToUser(user)" [disabled]="user.status === 'disabled'">
          <span class="material-icons">check_circle</span>
          Assign
        </button>
      </div>

      <div *ngIf="filteredUsersForAssign.length === 0 && userSearchEmail" class="no-users">
        <span class="material-icons">person_off</span>
        <p>No users found with email: <strong>{{ userSearchEmail }}</strong></p>
      </div>

      <div *ngIf="filteredUsersForAssign.length === 0 && !userSearchEmail" class="no-users">
        <span class="material-icons">people</span>
        <p>Start typing an email to search for users</p>
      </div>
    </div>
  </div>
</div>